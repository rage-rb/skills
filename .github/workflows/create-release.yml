name: Create GitHub Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-tags: true

      - name: Create release if it doesn't exist
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          # If release already exists, exit cleanly
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists. Skipping."
            exit 0
          fi

          HIGHEST="$(
            git tag -l 'v*' \
              | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' \
              | sed 's/^v//' \
              | sort -V \
              | tail -n 1
          )"

          HIGHEST="v${HIGHEST}"

          if [[ "$TAG" == "$HIGHEST" ]]; then
            echo "$TAG is highest stable version → mark as latest"
            LATEST_FLAG="--latest=true"
          else
            echo "$TAG is not highest (highest is $HIGHEST) → not latest"
            LATEST_FLAG="--latest=false"
          fi

          mkdir -p dist

          ARTIFACT="dist/skills.tar.gz"
          echo "artifact=$ARTIFACT" >> "$GITHUB_OUTPUT"

          tar -czf "$ARTIFACT" SKILL.md references/

          # Create checksum file
          sha256sum "$ARTIFACT" > "checksums.txt"

          gh release create "$TAG" \
            "$ARTIFACT" \
            "${ARTIFACT}.sha256" \
            --title "$TAG" \
            --notes "Release $TAG" \
            --verify-tag \
            $LATEST_FLAG

          echo "Created release $TAG with assets:"
          echo " - $(basename "$ARTIFACT")"
          echo " - $(basename "${ARTIFACT}.sha256")"

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: ${{ steps.release.outputs.artifact }}
